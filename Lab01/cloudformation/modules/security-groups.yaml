AWSTemplateFormatVersion: "2010-09-09"
Description: Security Groups Module - Creates security groups for Public and Private EC2 instances

Parameters:
  ProjectName:
    Type: String
    Default: cf-project
    Description: Project name for resource tagging

  VpcId:
    Type: String
    Description: VPC ID to attach security groups

  UserIP:
    Type: String
    Description: Your IP address for SSH access (e.g., 1.2.3.4/32)

Resources:
  # 1. PUBLIC EC2 SECURITY GROUP
  # Allows SSH from your IP
  PublicSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: !Sub ${ProjectName}-public-ec2-sg
      GroupDescription: Security Group for Public EC2 Instance - SSH from user IP
      VpcId: !Ref VpcId
      SecurityGroupIngress:
        - Description: SSH from my IP
          IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: !Ref UserIP
      SecurityGroupEgress:
        - Description: Allow all outbound traffic
          IpProtocol: -1
          FromPort: 0
          ToPort: 0
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-public-ec2-sg

  # 2. PRIVATE EC2 SECURITY GROUP
  # Allows SSH only from Public EC2 Security Group
  PrivateSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: !Sub ${ProjectName}-private-ec2-sg
      GroupDescription: Security Group for Private EC2 Instance - SSH from Public SG only
      VpcId: !Ref VpcId
      SecurityGroupIngress:
        - Description: SSH from Public EC2 SG
          IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          SourceSecurityGroupId: !Ref PublicSecurityGroup
      SecurityGroupEgress:
        - Description: Allow all outbound traffic
          IpProtocol: -1
          FromPort: 0
          ToPort: 0
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-private-ec2-sg

Outputs:
  PublicSGId:
    Description: Public Security Group ID
    Value: !Ref PublicSecurityGroup

  PrivateSGId:
    Description: Private Security Group ID
    Value: !Ref PrivateSecurityGroup
